FROM apache/spark:3.5.0

ARG GCS_CONNECTOR_VERSION=2.2.5

USER root

# Basic utilities
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# --- GCS Connector (shaded) ---
RUN curl -fL -o /opt/spark/jars/gcs-connector-hadoop3-${GCS_CONNECTOR_VERSION}-shaded.jar \
  https://repo1.maven.org/maven2/com/google/cloud/bigdataoss/gcs-connector/hadoop3-${GCS_CONNECTOR_VERSION}/gcs-connector-hadoop3-${GCS_CONNECTOR_VERSION}-shaded.jar \
  && chmod 644 /opt/spark/jars/gcs-connector-hadoop3-${GCS_CONNECTOR_VERSION}-shaded.jar \
  && rm -f /opt/spark/jars/gcs-connector-hadoop3-${GCS_CONNECTOR_VERSION}.jar \
  && echo "GCS connector installed:" \
  && ls -lah /opt/spark/jars | grep gcs

# --- JupyterLab ---
RUN pip install --no-cache-dir pyspark jupyterlab

# ✅ Change spark user's UID to 1000 (match host)
RUN usermod -u 1000 spark && groupmod -g 1000 spark

RUN mkdir -p /opt/spark/work \
  && chown -R spark:spark /opt/spark/work

# ✅ Directories for Jupyter / Spark / Ivy (container-only paths)
RUN mkdir -p \
    /home/spark/.jupyter/runtime \
    /home/spark/.jupyter/data \
    /home/spark/.ipython \
    /home/spark/.ivy2 \
 && chown -R 1000:1000 /home/spark

# ✅ Standardize HOME
ENV HOME=/home/spark

USER spark
WORKDIR /home/spark/work
